<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>WebXR 파노라마 투어</title>

<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://unpkg.com/aframe-look-at-component@1.0.0/dist/aframe-look-at-component.min.js"></script>

<style>
  html,body{margin:0;height:100%;background:#000}
  body{display:flex;justify-content:center;align-items:center}
  a-scene{width:auto;height:100vh;max-width:100vw;aspect-ratio:16/9}
  #sceneLabel{position:fixed;top:8px;left:8px;z-index:10;padding:6px 10px;background:#0009;color:#fff;border-radius:6px;font:16px/1.2 sans-serif;pointer-events:none}
  #coord{position:fixed;left:8px;bottom:8px;z-index:10;padding:6px 10px;background:#0009;color:#fff;border-radius:6px;font:12px/1.2 monospace;pointer-events:none}
  #controls{position:fixed;top:8px;right:8px;z-index:11;display:flex;gap:8px;pointer-events:auto}
  #controls button{padding:8px 10px;border-radius:6px;border:1px solid #0003;background:#fff;cursor:pointer}
  #uiRight{position:fixed;top:60px;right:8px;width:260px;z-index:12;pointer-events:none}
  #minimap{position:relative;width:100%;aspect-ratio:10.28/12.75;border-radius:8px;background:#222 center/cover no-repeat;box-shadow:0 2px 10px #0006;overflow:hidden;pointer-events:auto}
  .mm-pin{position:absolute;transform:translate(-50%,-50%);width:18px;height:18px;border-radius:50%;background:#ff0c;border:2px solid #0008;box-shadow:0 0 6px #0007;cursor:pointer}
  .mm-label{position:absolute;transform:translate(-50%,-125%);color:#fff;background:#0009;font:12px/1.1 sans-serif;padding:2px 6px;border-radius:4px;pointer-events:none}
  .hs{pointer-events:auto}
  @media (orientation:portrait){
    a-scene{width:100vw;height:100vh;max-width:100vw;aspect-ratio:auto}
  }
</style>
</head>
<body>
<div id="sceneLabel">-</div>
<div id="coord">pitch:-, yaw:-, fov:-</div>
<div id="controls">
  <button id="tourPlay">자동투어 시작</button>
  <button id="tourPause">자동투어 정지</button>
  <button id="enterVR">VR 모드</button>
</div>
<div id="uiRight"><div id="minimap"></div></div>

<a-scene id="scene" renderer="antialias:true; colorManagement:true" vr-mode-ui="enabled:true">
  <a-entity id="rig" position="0 1.6 0">
    <!-- 데스크탑: 마우스, VR: 시선 커서(fuse) -->
    <a-entity id="cam"
      camera="fov:80"
      look-controls
      cursor="rayOrigin: mouse"
      raycaster="objects: .hs, .hs *; recursive: true; useWorldCoordinates: true; far: 2000; interval: 0">

      <!-- VR 시선 커서: VR에서만 표시 -->
      <a-entity id="vrCursor"
        position="0 0 -1"
        geometry="primitive:ring; radiusInner:0.01; radiusOuter:0.015"
        material="color:#fff; shader:flat; opacity:0.95"
        visible="false"
        cursor="rayOrigin: entity; fuse: true; fuseTimeout: 700"
        raycaster="objects: .hs, .hs *; recursive: true; far: 2000">
      </a-entity>

      <!-- VR 라벨: 현재 씬 이름 표시 -->
      <a-text id="vrLabel"
        value="-" align="center" color="#FFFFFF" width="1.8"
        position="0 -0.25 -0.9" visible="false"></a-text>
    </a-entity>
  </a-entity>

  <a-sky id="sky" radius="500" rotation="0 0 0" src=""></a-sky>
  <a-entity id="hotspots"></a-entity>
</a-scene>

<script>
(async function(){
  const cfg = await fetch('tour.config.json',{cache:'no-cache'}).then(r=>r.json());

  // === 상수 ===
  const YAW_MODE            = cfg.constants?.YAW_MODE            || "NEG";
  const HS_SPHERE_R         = cfg.constants?.HS_SPHERE_R         ?? 480;

  // 히트(인식) 반경과 표시 반경 분리
  const HS_HIT_R            = cfg.constants?.HS_HIT_R ?? cfg.constants?.HS_RADIUS ?? 16; // 클릭 범위
  const HS_VIS_R            = cfg.constants?.HS_VIS_R ?? 10;                              // 보이는 크기

  const TARGET_PITCH_SIGN   = cfg.constants?.TARGET_PITCH_SIGN   ?? 1;
  const TARGET_YAW_SIGN     = cfg.constants?.TARGET_YAW_SIGN     ?? 1;
  const FADE_MS             = cfg.constants?.FADE_MS             ?? 600;
  const AUTO_ROT_SPEED_TOUR = cfg.constants?.AUTO_ROT_SPEED_TOUR ?? 8;

  const TARGET     = cfg.targets    || {};
  const sceneNames = cfg.sceneNames || {};
  const scenes     = {}; (cfg.scenes||[]).forEach(s=> scenes[s.id]=s);

  const scene = document.getElementById('scene');
  const sky   = document.getElementById('sky');
  const hsRoot= document.getElementById('hotspots');
  const rig   = document.getElementById('rig');
  const cam   = document.getElementById('cam');
  const vrCur = document.getElementById('vrCursor');
  const vrLabel = document.getElementById('vrLabel');
  const vrBtn   = document.getElementById('enterVR');

  function setLabel(id){
    const name = sceneNames[id] || id || '-';
    document.getElementById('sceneLabel').textContent = name; // HTML 라벨
    vrLabel.setAttribute('value', name);                      // VR 라벨
  }
  function setCoord(){
    const rot = cam.getAttribute('rotation');
    const fov = cam.getAttribute('camera').fov;
    let yaw = rot.y; yaw = yaw % 360; if (yaw > 180) yaw -= 360; if (yaw < -180) yaw += 360;
    document.getElementById('coord').textContent = `pitch:${(rot.x).toFixed(1)}, yaw:${yaw.toFixed(1)}, fov:${fov.toFixed(1)}`;
  }
  setInterval(setCoord, 250);

  // VR 버튼: 모바일 세로모드 포함 항상 동작
  document.getElementById('enterVR').onclick = async () => {
    try { await scene.enterVR(); } catch(e){ console.warn(e); }
  };

  // VR 진입/종료: 커서/라벨 토글
  scene.addEventListener('enter-vr', ()=>{
    vrCur.setAttribute('visible', true);
    vrLabel.setAttribute('visible', true);
  });
  scene.addEventListener('exit-vr',  ()=>{
    vrCur.setAttribute('visible', false);
    vrLabel.setAttribute('visible', false);
  });

  // 미니맵
  (function buildMinimap(){
    const el = document.getElementById('minimap');
    el.style.backgroundImage = `url("${cfg.assets.minimap}")`;
    for(const pin of (cfg.minimapPins||[])){
      const p = document.createElement('div');
      p.className='mm-pin'; p.style.left=pin.left; p.style.top=pin.top; p.onclick=()=>go(pin.scene);
      const lab=document.createElement('div');
      lab.className='mm-label'; lab.style.left=pin.left; lab.style.top=`calc(${pin.top} - 3%)`; lab.textContent=pin.label;
      el.appendChild(p); el.appendChild(lab);
    }
  })();

  // 핫스팟 좌표
  function yawConv(y){ return (YAW_MODE==="NEG") ? y : (180 - y); }
  function hotspotPos(pitchDeg, yawDeg, R=HS_SPHERE_R){
    const t=Math.PI/180, p=pitchDeg*t, y=yawConv(yawDeg)*t;
    const x=R*Math.cos(p)*Math.sin(y), y3=R*Math.sin(p), z=-R*Math.cos(p)*Math.cos(y);
    return `${x} ${y3} ${z}`;
  }

  function clearHotspots(){ while(hsRoot.firstChild) hsRoot.removeChild(hsRoot.firstChild); }

  // ▶ 인식(히트) 반경과 표시 반경을 분리해 큰 히트영역 제공
  function makeHotspot(h){
    const root = document.createElement('a-entity');
    root.className='hs';
    root.setAttribute('position', hotspotPos(h.pitch, h.yaw));
    root.setAttribute('look-at','#cam');

    // 보이지 않는 큰 히트원
    const hit = document.createElement('a-entity');
    hit.className='hs';
    hit.setAttribute('geometry', `primitive: circle; radius: ${HS_HIT_R}`);
    hit.setAttribute('material','opacity:0.001; transparent:true; side:double; depthTest:false');

    // 보이는 작은 점
    const dot = document.createElement('a-entity');
    dot.setAttribute('geometry', `primitive: circle; radius: ${HS_VIS_R}`);
    dot.setAttribute('material','shader:flat; color:#ffda00; opacity:0.98; transparent:true; side:double; emissive:#ffda00; emissiveIntensity:1.0; depthTest:false');
    dot.object3D.renderOrder = 999;

    const goNow = ()=> go(h.to);
    root.addEventListener('click', goNow);
    hit.addEventListener('click', goNow);
    dot.addEventListener('click', goNow);
    root.addEventListener('touchstart', goNow, {passive:true});

    root.appendChild(hit);
    root.appendChild(dot);
    return root;
  }

  // HFOV→VFOV
  function setFovFromHFOV(hfov){
    const sceneEl = document.querySelector('a-scene');
    const cw = sceneEl.canvas?.clientWidth || window.innerWidth;
    const ch = sceneEl.canvas?.clientHeight || window.innerHeight;
    const aspect = cw / ch;
    const hf=(hfov??100)*Math.PI/180;
    const vf=2*Math.atan(Math.tan(hf/2)/aspect)*180/Math.PI;
    cam.setAttribute('camera','fov', Math.max(40, Math.min(110, vf)));
  }

  // 페이드
  AFRAME.registerComponent('fade-sky',{
    init(){
      this.el.setAttribute('animation__out',{property:'material.color',to:'#000',startEvents:'fadeout',dur:FADE_MS/2});
      this.el.setAttribute('animation__in',{property:'material.color',from:'#000',to:'#FFF',startEvents:'fadein',dur:FADE_MS/2});
    }
  });
  sky.setAttribute('fade-sky','');

  // 투어 자동회전(투어 중만)
  function startAutoRot(){
    rig.setAttribute('animation__yaw',
      `property: rotation; to: 0 -360 0; loop: true; dur:${360/Math.max(1,AUTO_ROT_SPEED_TOUR)*1000}; easing: linear`);
  }
  function stopAutoRot(){ rig.removeAttribute('animation__yaw'); }

  // 시점 세팅
  function setView(p,y){
    const r=Math.PI/180, lc=cam.components['look-controls'];
    const P=p, Y=y;
    if(lc&&lc.yawObject&&lc.pitchObject){
      lc.yawObject.rotation.set(0,(-Y)*r,0);
      lc.pitchObject.rotation.x=(-P)*r;
    }
    cam.object3D.rotation.set((-P)*r,(-Y)*r,0);
    rig.object3D.rotation.set(0,0,0);
  }

  // 상태
  let transitioning=false, touring=false, tourIdx=0, tourTimer=null;

  function loadScene(id,p=0,y=0,f=100){
    if(transitioning) return;
    if(!scenes[id]){ console.warn('unknown scene id:',id); return; }
    if(!cfg.assets?.panoramas?.[id]){ console.warn('panorama missing for id:',id); return; }
    transitioning=true;
    sky.emit('fadeout');
    setTimeout(()=>{
      sky.setAttribute('src', cfg.assets.panoramas[id]);
      setFovFromHFOV(f || scenes[id].hfov);
      setView(p,y);
      clearHotspots();
      (scenes[id].hotSpots||[]).forEach(h=> hsRoot.appendChild(makeHotspot(h)));
      setLabel(id); setCoord();
      sky.emit('fadein');
      transitioning=false;
    }, FADE_MS/2);
  }

  function go(id){
    const t = TARGET[id] || {p:0,y:0,f: scenes[id]?.hfov ?? 100};
    loadScene(id, t.p*cfg.constants.TARGET_PITCH_SIGN, t.y*cfg.constants.TARGET_YAW_SIGN, t.f);
  }
  window.go=go;

  // 자동 투어
  const tourOrder = cfg.tour?.order || Object.keys(scenes);
  const defaultDwell = cfg.tour?.dwellMs ?? 3000;
  const perSceneDwell = cfg.tour?.perSceneDwell || {};
  function tourStep(i){
    if(!touring) return;
    const id = tourOrder[i % tourOrder.length];
    go(id);
    clearTimeout(tourTimer);
    tourTimer=setTimeout(()=>{ if(touring) tourStep((i+1)%tourOrder.length); },
                          (perSceneDwell[id] ?? defaultDwell) + FADE_MS);
  }
  document.getElementById('tourPlay').onclick=()=>{ if(touring) return; touring=true; startAutoRot(); tourStep(tourIdx); };
  document.getElementById('tourPause').onclick=()=>{ touring=false; clearTimeout(tourTimer); stopAutoRot(); };

  // 확대/축소
  const FOV_MIN=35, FOV_MAX=110, FOV_STEP=3;
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
  const setFov=v=>cam.setAttribute('camera','fov',clamp(v,FOV_MIN,FOV_MAX));
  const getFov=()=>cam.getAttribute('camera').fov;
  window.addEventListener('wheel', e=>{ setFov(getFov()+Math.sign(e.deltaY)*FOV_STEP); },{passive:true});
  let pinch0=null;
  window.addEventListener('touchstart', e=>{
    if(e.touches.length===2){
      const dx=e.touches[0].clientX-e.touches[1].clientX;
      const dy=e.touches[0].clientY-e.touches[1].clientY;
      pinch0=Math.hypot(dx,dy);
    }
  },{passive:true});
  window.addEventListener('touchmove', e=>{
    if(e.touches.length===2&&pinch0){
      const dx=e.touches[0].clientX-e.touches[1].clientX;
      const dy=e.touches[0].clientY-e.touches[1].clientY;
      const d=Math.hypot(dx,dy);
      const k=(pinch0-d)/80;
      setFov(getFov()+k*FOV_STEP);
      pinch0=d;
    }
  },{passive:true});
  window.addEventListener('touchend', ()=>{ pinch0=null; }, {passive:true});

  // 시작
  const first = cfg.defaults?.firstScene || Object.keys(scenes)[0];
  const t0 = TARGET[first] || {p:0,y:0,f: scenes[first]?.hfov ?? 100};
  loadScene(first, t0.p*cfg.constants.TARGET_PITCH_SIGN, t0.y*cfg.constants.TARGET_YAW_SIGN, t0.f);
})();
</script>
</body>
</html>
