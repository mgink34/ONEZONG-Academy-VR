<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css">
<script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
<style>
  body{margin:0}
  #p{width:100vw;height:100vh}
  .hs{width:22px;height:22px;border-radius:50%;background:#fff8;border:2px solid #0007;box-shadow:0 0 6px #0006;cursor:pointer}
  #coord{position:fixed;left:8px;bottom:8px;padding:6px 8px;background:#000a;color:#fff;font:12px/1.2 monospace;border-radius:4px;z-index:11}
  #sceneLabel{position:fixed;top:8px;left:50%;transform:translateX(-50%);z-index:14;padding:6px 10px;border-radius:6px;background:#0009;color:#fff;font:30px/1.2 sans-serif}
  #rotateHint{position:fixed;top:72px;left:50%;transform:translateX(-50%);z-index:15;padding:4px 8px;border-radius:6px;background:rgba(255,255,255,.8);color:#f00;font:18px/1.2 sans-serif}
  #minimap.tour-hide{opacity:0;pointer-events:none;transition:opacity .2s}
  #controls.tour-pos{position:fixed;right:8px;top:8px;z-index:16;gap:10px}
  #controls.tour-pos button{padding:10px 14px}
  #coord.tour-hide{opacity:0;pointer-events:none;transition:opacity .2s}
  @media (orientation:landscape){ #rotateHint{display:none} }
  #uiRight{position:fixed;top:8px;right:8px;z-index:12;width:260px;pointer-events:none}
  #minimap{
    position:relative;width:100%;aspect-ratio:10.28/12.75;border-radius:8px;
    background:#222 center/cover no-repeat;
    box-shadow:0 2px 10px #0006;overflow:hidden;pointer-events:auto
  }
  .mm-pin{position:absolute;transform:translate(-50%,-50%);width:18px;height:18px;border-radius:50%;background:#ff0c;border:2px solid #0008;box-shadow:0 0 6px #0007;cursor:pointer}
  .mm-pin:hover{background:#ff0e}
  .mm-label{position:absolute;transform:translate(-50%,-125%);color:#fff;background:#0009;font:12px/1.1 sans-serif;padding:2px 6px;border-radius:4px;pointer-events:none}
  #controls{margin-top:8px;display:flex;gap:8px;justify-content:flex-end;pointer-events:auto}
  #controls button{padding:8px 10px;border:1px solid #0003;border-radius:6px;cursor:pointer;background:#fff9}
  #tourPlay,#tourPause{position:static}
  @media (max-width:480px){ #uiRight{width:180px} }
</style>
</head>
<body>
<div id="p"></div>
<div id="sceneLabel">-</div>
<div id="rotateHint">화면을 가로로 돌려주세요</div>
<div id="coord">pitch:-, yaw:-, hfov:-</div>

<div id="uiRight">
  <div id="minimap"></div>
  <div id="controls">
    <button id="tourPlay">자동투어 시작</button>
    <button id="tourPause">자동투어 정지</button>
  </div>
</div>

<script>
(async function(){
  const cfg = await fetch('tour.config.json', {cache:'no-cache'}).then(r=>r.json());

  const FADE_MS = cfg.constants.FADE_MS;
  const AUTO_ROT_SPEED_TOUR = cfg.constants.AUTO_ROT_SPEED_TOUR;
  const AUTO_ROT_IDLE_MS = cfg.constants.AUTO_ROT_IDLE_MS;

  const TARGET = cfg.targets;
  const sceneNames = cfg.sceneNames;
  const firstScene = cfg.defaults.firstScene;

  function buildPannellumConfig(){
    const scenes = {};
    for(const s of cfg.scenes){
      scenes[s.id] = {
        type: "equirectangular",
        panorama: cfg.assets.panoramas[s.id],
        hfov: s.hfov,
        hotSpots: s.hotSpots.map(h=>({
          pitch: h.pitch, yaw: h.yaw, cssClass: "hs",
          createTooltipFunc: el => el.title = h.label,
          clickHandlerFunc: ()=> go(h.to)
        }))
      };
    }
    return {
      default: { firstScene, sceneFadeDuration: FADE_MS, autoLoad: true },
      scenes
    };
  }

  const viewer = pannellum.viewer('p', buildPannellumConfig());

  function isFS(){ return document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement; }
  const isAndroidChrome = /Android/i.test(navigator.userAgent) && !!window.chrome;
  const canLock = 'orientation' in screen && 'lock' in screen.orientation;
  async function tryLockLandscape(){ if(!isAndroidChrome||!canLock) return; try{ await screen.orientation.lock('landscape'); }catch{} }
  function tryUnlock(){ try{ screen.orientation.unlock?.(); }catch{} }
  function onFSChange(){ if (isFS()) tryLockLandscape(); else tryUnlock(); }
  document.addEventListener('fullscreenchange', onFSChange);
  document.addEventListener('webkitfullscreenchange', onFSChange);
  function enterFS(el){ return el.requestFullscreen?.() || el.webkitRequestFullscreen?.() || el.msRequestFullscreen?.(); }
  function exitFS(){ return document.exitFullscreen?.() || document.webkitExitFullscreen?.() || document.msExitFullscreen?.(); }

  function setTourUI(on){
    document.getElementById('minimap').classList.toggle('tour-hide', on);
    document.getElementById('controls').classList.toggle('tour-pos', on);
    document.getElementById('coord').classList.toggle('tour-hide', on);
  }

  let transitioning=false;
  function flyAndLoad(id,p,y,f){
    if(transitioning) return;
    transitioning=true;
    viewer.loadScene(id,p,y,f,FADE_MS);
    setTimeout(()=>{transitioning=false},FADE_MS+50);
  }
  function go(id){
    const t = TARGET[id] || {p:0,y:0,f:120};
    flyAndLoad(id,t.p,t.y,t.f);
  }
  window.go = go;

  function buildMinimap(){
    const el = document.getElementById('minimap');
    el.style.backgroundImage = `url("${cfg.assets.minimap}")`;
    for(const pin of cfg.minimapPins){
      const p = document.createElement('div');
      p.className = 'mm-pin';
      p.style.left = pin.left;
      p.style.top = pin.top;
      p.dataset.scene = pin.scene;
      p.addEventListener('click', ()=> go(pin.scene));
      const lab = document.createElement('div');
      lab.className = 'mm-label';
      lab.style.left = pin.left;
      lab.style.top = `calc(${pin.top} - 3%)`;
      lab.textContent = pin.label;
      el.appendChild(p);
      el.appendChild(lab);
    }
  }
  buildMinimap();

  const tourOrder = cfg.tour.order;
  const defaultDwell = cfg.tour.dwellMs;
  const perSceneDwell = cfg.tour.perSceneDwell || {};
  const tourSteps = tourOrder.map(id=>({
    scene:id,
    ...(TARGET[id] || {p:0,y:0,f:120}),
    dwell: perSceneDwell[id] ?? defaultDwell
  }));

  let tourIdx=0,tourTimer=null,touring=false,idleTimer=null;
  function gotoStep(i){
    const s=tourSteps[i%tourSteps.length];
    const onLoad=()=>{
      viewer.off('load',onLoad);
      if(!touring){ try{viewer.stopAutoRotate();}catch{}; return; }
      try{viewer.startAutoRotate(AUTO_ROT_SPEED_TOUR);}catch{}
      updateSceneLabel();
    };
    viewer.on('load',onLoad);
    viewer.loadScene(s.scene,s.p,s.y,s.f,FADE_MS);
  }
  function nextStep(){
    if(!touring) return;
    tourIdx=(tourIdx+1)%tourSteps.length;
    gotoStep(tourIdx);
    clearTimeout(tourTimer);
    tourTimer=setTimeout(nextStep,tourSteps[tourIdx].dwell+FADE_MS);
  }

  document.getElementById('tourPlay').onclick = async ()=>{
    if (touring) return;
    if (!isFS()) { try{ await enterFS(document.documentElement); }catch(e){} }
    touring = true;
    setTourUI(true);
    gotoStep(tourIdx);
    clearTimeout(tourTimer);
    tourTimer = setTimeout(nextStep, tourSteps[tourIdx].dwell + FADE_MS);
  };

  document.getElementById('tourPause').onclick = async ()=>{
    touring = false;
    clearTimeout(tourTimer);
    try{ viewer.stopAutoRotate(); }catch{}
    setTourUI(false);
    try{ await exitFS(); }catch{}
    try{ screen.orientation.unlock?.(); }catch{}
  };

  ['fullscreenchange','webkitfullscreenchange'].forEach(ev=>{
    document.addEventListener(ev, ()=>{ if(!isFS()) setTourUI(false); });
  });

  ['mousedown','touchstart','wheel','keydown'].forEach(ev=>{
    window.addEventListener(ev,()=>{
      if(!touring) return;
      try{viewer.stopAutoRotate()}catch{}
      clearTimeout(idleTimer);
      idleTimer=setTimeout(()=>{
        if(touring){ try{viewer.startAutoRotate(AUTO_ROT_SPEED_TOUR)}catch{} }
      },AUTO_ROT_IDLE_MS);
    },{passive:true});
  });

  function resume(){
    setTimeout(()=>{
      if(touring){ try{viewer.startAutoRotate(AUTO_ROT_SPEED_TOUR)}catch{} }
      updateSceneLabel();
    },80);
  }
  ['fullscreenchange','webkitfullscreenchange','msfullscreenchange'].forEach(ev=>document.addEventListener(ev,resume));
  window.addEventListener('resize',resume);
  window.addEventListener('orientationchange',resume);

  function updateSceneLabel(){
    const id=viewer.getScene();
    document.getElementById('sceneLabel').textContent = sceneNames[id] || id || '-';
  }
  viewer.on('load',updateSceneLabel);
  updateSceneLabel();

  function updateHUD(){
    const a=viewer.getPitch().toFixed(2), b=viewer.getYaw().toFixed(2), c=viewer.getHfov().toFixed(2);
    document.getElementById('coord').textContent=`pitch:${a}, yaw:${b}, hfov:${c}`;
  }
  ['mouseup','touchend','wheel','keydown'].forEach(ev=>window.addEventListener(ev,updateHUD));
})();
</script>
</body>
</html>
