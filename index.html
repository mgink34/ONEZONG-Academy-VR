<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>WebXR 파노라마 투어</title>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://unpkg.com/aframe-look-at-component@1.0.0/dist/aframe-look-at-component.min.js"></script>
<script src="https://unpkg.com/aframe-troika-text/dist/aframe-troika-text.min.js"></script>
<style>
  html,body{margin:0;height:100%;background:#000}
  body{display:flex;justify-content:center;align-items:center}
  a-scene{width:auto;height:100vh;max-width:100vw;aspect-ratio:16/9}
  /* DOM Overlay */
  #hud{position:fixed;inset:0;pointer-events:none;z-index:15}
  #sceneLabel{position:absolute;top:8px;left:8px;padding:6px 10px;background:#0009;color:#fff;border-radius:6px;font:16px/1.2 sans-serif}
  #coord{position:absolute;left:8px;bottom:8px;padding:6px 10px;background:#0009;color:#fff;border-radius:6px;font:12px/1.2 monospace}
  #controls{position:fixed;top:8px;right:8px;z-index:11;display:flex;gap:8px;pointer-events:auto}
  #controls button{padding:8px 10px;border-radius:6px;border:1px solid #0003;background:#fff;cursor:pointer}
  #uiRight{position:fixed;top:60px;right:8px;width:260px;z-index:12;pointer-events:none}
  #minimap{position:relative;width:100%;aspect-ratio:10.28/12.75;border-radius:8px;background:#222 center/cover no-repeat;box-shadow:0 2px 10px #0006;overflow:hidden;pointer-events:auto}
  .mm-pin{position:absolute;transform:translate(-50%,-50%);width:18px;height:18px;border-radius:50%;background:#ff0c;border:2px solid #0008;box-shadow:0 0 6px #0007;cursor:pointer}
  .mm-label{position:absolute;transform:translate(-50%,-125%);color:#fff;background:#0009;font:12px/1.1 sans-serif;padding:2px 6px;border-radius:4px;pointer-events:none}
  .hs{pointer-events:auto}
  @media (orientation:portrait){ a-scene{width:100vw;height:100vh;max-width:100vw;aspect-ratio:auto} }

  /* 전체화면 대체 레이아웃 (iOS 등) */
  body.fs-like{position:fixed;inset:0;width:100vw;height:100vh;overflow:hidden;background:#000}
  body.fs-like a-scene{width:100vw;height:100vh;max-width:100vw;aspect-ratio:auto}
</style>
</head>
<body>

<!-- DOM Overlay -->
<div id="hud">
  <div id="sceneLabel">-</div>
  <div id="coord">pitch:-, yaw:-, fov:-</div>
</div>

<div id="controls">
  <button id="tourPlay">자동투어 시작</button>
  <button id="tourPause">자동투어 정지</button>
  <button id="enterVR">VR 모드</button>
</div>
<div id="uiRight"><div id="minimap"></div></div>

<a-scene id="scene"
  renderer="antialias:true; colorManagement:true"
  vr-mode-ui="enabled:true"
  webxr="optionalFeatures: dom-overlay; overlayElement: #hud">

  <a-entity id="rig" position="0 1.6 0">
    <a-entity id="cam"
      camera="fov:80"
      look-controls
      cursor="rayOrigin: mouse"
      raycaster="objects: .hs, .hs *; recursive: true; useWorldCoordinates: true; far: 2000; interval: 0">

      <a-entity id="vrCursor"
        position="0 0 -1"
        geometry="primitive:ring; radiusInner:0.01; radiusOuter:0.015"
        material="color:#fff; shader:flat; opacity:0.95"
        visible="false"
        cursor="rayOrigin: entity; fuse: true; fuseTimeout: 700"
        raycaster="objects: .hs, .hs *; recursive: true; far: 2000">
      </a-entity>

      <!-- DOM 오버레이 미지원 시 사용할 3D 라벨 -->
      <a-entity id="vrLabel3D" visible="false" position="-0.45 0.32 -0.7">
        <a-plane id="vrLabelPlane" width="0.9" height="0.2"
                 material="color:#000; opacity:0.7; shader:flat; transparent:true; side:double; depthTest:false"></a-plane>
        <a-troika-text id="vrLabelText"
          value="-" color="#ffffff" position="0 0 0.002"
          anchor="center" baseline="center" max-width="0.8" font-size="0.085"
          font="fonts/NotoSansKR-Regular.ttf"></a-troika-text>
      </a-entity>
    </a-entity>
  </a-entity>

  <a-sky id="sky" radius="500" rotation="0 0 0" src=""></a-sky>
  <a-entity id="hotspots"></a-entity>
</a-scene>

<script>
(async function(){
  const cfg = await fetch(`tour.config.json?ts=${Date.now()}`,{cache:'no-cache'}).then(r=>r.json());

  // === 상수 ===
  const YAW_MODE=cfg.constants?.YAW_MODE||"NEG";
  const HS_SPHERE_R=cfg.constants?.HS_SPHERE_R??480;
  const HS_HIT_R=cfg.constants?.HS_HIT_R??cfg.constants?.HS_RADIUS??16;
  const HS_VIS_R=cfg.constants?.HS_VIS_R??10;
  const TARGET_PITCH_SIGN=cfg.constants?.TARGET_PITCH_SIGN??1;
  const TARGET_YAW_SIGN=cfg.constants?.TARGET_YAW_SIGN??1;
  const FADE_MS=cfg.constants?.FADE_MS??600;
  const AUTO_ROT_SPEED_TOUR=cfg.constants?.AUTO_ROT_SPEED_TOUR??8;

  const TARGET=cfg.targets||{};
  const sceneNames=cfg.sceneNames||{};
  const scenes={}; (cfg.scenes||[]).forEach(s=>scenes[s.id]=s);

  const scene=document.getElementById('scene');
  const sky=document.getElementById('sky');
  const hsRoot=document.getElementById('hotspots');
  const rig=document.getElementById('rig');
  const cam=document.getElementById('cam');
  const vrCur=document.getElementById('vrCursor');

  const vrLabel3D=document.getElementById('vrLabel3D');
  const vrLabelText=document.getElementById('vrLabelText');
  const vrLabelPlane=document.getElementById('vrLabelPlane');

  // JSON HUD 적용
  function applyHUDFromJSON(){
    const HUD = cfg.hud?.label3D || {};
    const pos = HUD.position || [-0.45, 0.32, -0.70];
    const plane = HUD.plane || {};
    const text  = HUD.text  || {};

    vrLabel3D.setAttribute('position', pos.join(' '));
    if (plane.width)  vrLabelPlane.setAttribute('width',  plane.width);
    if (plane.height) vrLabelPlane.setAttribute('height', plane.height);
    if (plane.opacity!=null){
      vrLabelPlane.setAttribute('material',
        `color:#000; opacity:${plane.opacity}; shader:flat; transparent:true; side:double; depthTest:false`);
    }
    if (text.fontSize) vrLabelText.setAttribute('font-size', text.fontSize);
    if (text.maxWidth) vrLabelText.setAttribute('max-width', text.maxWidth);
    if (text.color)    vrLabelText.setAttribute('color', text.color);
    if (text.font)     vrLabelText.setAttribute('font', text.font);
  }
  scene.addEventListener('loaded', applyHUDFromJSON);
  setTimeout(applyHUDFromJSON, 0);

  function setLabel(id){
    const name = sceneNames[id] || id || '-';
    document.getElementById('sceneLabel').textContent = name;
    vrLabelText.setAttribute('value', name);
    requestAnimationFrame(()=> vrLabelText.setAttribute('value', name));
  }
  function setCoord(){
    const rot=cam.getAttribute('rotation');
    const fov=cam.getAttribute('camera').fov;
    let yaw=rot.y; yaw%=360; if(yaw>180) yaw-=360; if(yaw<-180) yaw+=360;
    document.getElementById('coord').textContent=`pitch:${(rot.x).toFixed(1)}, yaw:${yaw.toFixed(1)}, fov:${fov.toFixed(1)}`;
  }
  setInterval(setCoord,250);

  // 전체화면+가로 고정 유틸
  async function enterFullscreenLandscape(){
    const root=document.documentElement;
    try{
      if(!document.fullscreenElement && root.requestFullscreen){
        await root.requestFullscreen({navigationUI:'hide'}).catch(()=>{});
      }
    }catch(_){}
    try{ await screen.orientation?.lock?.('landscape'); }catch(_){}
    if(!document.fullscreenElement) document.body.classList.add('fs-like');
  }
  async function exitFullscreenLandscape(){
    document.body.classList.remove('fs-like');
    try{ if(document.fullscreenElement) await document.exitFullscreen(); }catch(_){}
    try{ screen.orientation?.unlock?.(); }catch(_){}
  }

  // VR 버튼
  document.getElementById('enterVR').onclick=async()=>{ try{ await scene.enterVR(); }catch(e){ console.warn(e); } };

  // VR 진입/종료
  scene.addEventListener('enter-vr', async ()=>{
    await exitFullscreenLandscape(); // 자동투어용 전체화면 해제
    vrCur.setAttribute('visible', true);
    const sess = scene.renderer?.xr?.getSession?.();
    const hasDom = !!sess?.domOverlayState;
    vrLabel3D.setAttribute('visible', !hasDom);
    if (!hasDom){
      vrLabel3D.object3D.traverse(o=>{
        if (o.material){ o.material.depthTest=false; o.material.depthWrite=false; if('toneMapped' in o.material) o.material.toneMapped=false; o.material.needsUpdate=true; }
        o.renderOrder=10000;
      });
      vrLabelText.setAttribute('value', document.getElementById('sceneLabel').textContent || '-');
    }
  });
  scene.addEventListener('exit-vr', ()=>{
    vrCur.setAttribute('visible', false);
    vrLabel3D.setAttribute('visible', false);
  });

  // 미니맵
  (function(){
    const el=document.getElementById('minimap');
    el.style.backgroundImage=`url("${cfg.assets.minimap}")`;
    for(const pin of (cfg.minimapPins||[])){
      const p=document.createElement('div');
      p.className='mm-pin'; p.style.left=pin.left; p.style.top=pin.top; p.onclick=()=>go(pin.scene);
      const lab=document.createElement('div');
      lab.className='mm-label'; lab.style.left=pin.left; lab.style.top=`calc(${pin.top} - 3%)`; lab.textContent=pin.label;
      el.appendChild(p); el.appendChild(lab);
    }
  })();

  // 핫스팟
  function yawConv(y){ return (YAW_MODE==="NEG") ? y : (180 - y); }
  function hotspotPos(pitchDeg,yawDeg,R=HS_SPHERE_R){
    const t=Math.PI/180, p=pitchDeg*t, y=yawConv(yawDeg)*t;
    const x=R*Math.cos(p)*Math.sin(y), y3=R*Math.sin(p), z=-R*Math.cos(p)*Math.cos(y);
    return `${x} ${y3} ${z}`;
  }
  function clearHotspots(){ while(hsRoot.firstChild) hsRoot.removeChild(hsRoot.firstChild); }
  function makeHotspot(h){
    const root=document.createElement('a-entity');
    root.className='hs';
    root.setAttribute('position',hotspotPos(h.pitch,h.yaw));
    root.setAttribute('look-at','#cam');

    const hit=document.createElement('a-entity');
    hit.className='hs';
    hit.setAttribute('geometry',`primitive: circle; radius: ${HS_HIT_R}`);
    hit.setAttribute('material','opacity:0.001; transparent:true; side:double; depthTest:false');

    const dot=document.createElement('a-entity');
    dot.setAttribute('geometry',`primitive: circle; radius: ${HS_VIS_R}`);
    dot.setAttribute('material','shader:flat; color:#ffda00; opacity:0.98; transparent:true; side:double; emissive:#ffda00; emissiveIntensity:1.0; depthTest:false');
    dot.object3D.renderOrder=999;

    const goNow=()=>go(h.to);
    root.addEventListener('click',goNow);
    hit.addEventListener('click',goNow);
    dot.addEventListener('click',goNow);
    root.addEventListener('touchstart',goNow,{passive:true});

    root.appendChild(hit); root.appendChild(dot);
    return root;
  }

  // HFOV→VFOV
  function setFovFromHFOV(hfov){
    const sceneEl=document.querySelector('a-scene');
    const cw=sceneEl.canvas?.clientWidth||window.innerWidth;
    const ch=sceneEl.canvas?.clientHeight||window.innerHeight;
    const aspect=cw/ch;
    const hf=(hfov??100)*Math.PI/180;
    const vf=2*Math.atan(Math.tan(hf/2)/aspect)*180/Math.PI;
    cam.setAttribute('camera','fov',Math.max(40,Math.min(110,vf)));
  }

  // 페이드
  AFRAME.registerComponent('fade-sky',{
    init(){
      this.el.setAttribute('animation__out',{property:'material.color',to:'#000',startEvents:'fadeout',dur:FADE_MS/2});
      this.el.setAttribute('animation__in',{property:'material.color',from:'#000',to:'#FFF',startEvents:'fadein',dur:FADE_MS/2});
    }
  });
  sky.setAttribute('fade-sky','');

  function startAutoRot(){
    rig.setAttribute('animation__yaw',`property: rotation; to: 0 -360 0; loop: true; dur:${360/Math.max(1,AUTO_ROT_SPEED_TOUR)*1000}; easing: linear`);
  }
  function stopAutoRot(){ rig.removeAttribute('animation__yaw'); }

  function setView(p,y){
    const r=Math.PI/180, lc=cam.components['look-controls'];
    const P=p, Y=y;
    if(lc&&lc.yawObject&&lc.pitchObject){
      lc.yawObject.rotation.set(0,(-Y)*r,0);
      lc.pitchObject.rotation.x=(-P)*r;
    }
    cam.object3D.rotation.set((-P)*r,(-Y)*r,0);
    rig.object3D.rotation.set(0,0,0);
  }

  // 상태
  let transitioning=false, touring=false, tourIdx=0, tourTimer=null;

  // 로딩/이동
  function loadScene(id,p=0,y=0,f=100){
    if(transitioning) return;
    if(!scenes[id]){ console.warn('unknown scene id:',id); return; }
    if(!cfg.assets?.panoramas?.[id]){ console.warn('panorama missing for id:',id); return; }
    transitioning=true;
    sky.emit('fadeout');
    setTimeout(()=>{
      sky.setAttribute('src',cfg.assets.panoramas[id]);
      setFovFromHFOV(f||scenes[id].hfov);
      setView(p,y);
      clearHotspots();
      (scenes[id].hotSpots||[]).forEach(h=>hsRoot.appendChild(makeHotspot(h)));
      setLabel(id);
      setCoord();
      sky.emit('fadein');
      transitioning=false;
    },FADE_MS/2);
  }
  function go(id){
    const t=TARGET[id]||{p:0,y:0,f:scenes[id]?.hfov??100};
    loadScene(id,t.p*TARGET_PITCH_SIGN,t.y*TARGET_YAW_SIGN,t.f);
  }
  window.go=go;

  // 자동 투어
  const tourOrder=cfg.tour?.order||Object.keys(scenes);
  const defaultDwell=cfg.tour?.dwellMs??3000;
  const perSceneDwell=cfg.tour?.perSceneDwell||{};
  function tourStep(i){
    if(!touring) return;
    const id=tourOrder[i%tourOrder.length];
    go(id);
    clearTimeout(tourTimer);
    tourTimer=setTimeout(()=>{ if(touring) tourStep((i+1)%tourOrder.length); },(perSceneDwell[id]??defaultDwell)+FADE_MS);
  }

  // 버튼
  document.getElementById('tourPlay').onclick = async ()=>{
    if (touring) return;
    await enterFullscreenLandscape();   // 자동투어 시작 시 전체화면+가로
    touring = true;
    startAutoRot();
    tourStep(tourIdx);
  };
  document.getElementById('tourPause').onclick = async ()=>{
    touring = false;
    clearTimeout(tourTimer);
    stopAutoRot();
    await exitFullscreenLandscape();    // 자동투어 정지 시 해제
  };

  // 줌
  const FOV_MIN=35, FOV_MAX=110, FOV_STEP=3;
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
  const setFov=v=>cam.setAttribute('camera','fov',clamp(v,FOV_MIN,FOV_MAX));
  const getFov=()=>cam.getAttribute('camera').fov;
  window.addEventListener('wheel',e=>{ setFov(getFov()+Math.sign(e.deltaY)*FOV_STEP); },{passive:true});
  let pinch0=null;
  window.addEventListener('touchstart',e=>{
    if(e.touches.length===2){
      const dx=e.touches[0].clientX-e.touches[1].clientX;
      const dy=e.touches[0].clientY-e.touches[1].clientY;
      pinch0=Math.hypot(dx,dy);
    }
  },{passive:true});
  window.addEventListener('touchmove',e=>{
    if(e.touches.length===2&&pinch0){
      const dx=e.touches[0].clientX-e.touches[1].clientX;
      const dy=e.touches[0].clientY-e.touches[1].clientY;
      const d=Math.hypot(dx,dy);
      const k=(pinch0-d)/80;
      setFov(getFov()+k*FOV_STEP);
      pinch0=d;
    }
  },{passive:true});
  window.addEventListener('touchend',()=>{ pinch0=null; },{passive:true});

  // 시작
  const first=cfg.defaults?.firstScene||Object.keys(scenes)[0];
  const t0=TARGET[first]||{p:0,y:0,f:scenes[first]?.hfov??100};
  loadScene(first,t0.p*TARGET_PITCH_SIGN,t0.y*TARGET_YAW_SIGN,t0.f);
})();
</script>
</body>
</html>
