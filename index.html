<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<style>
  html,body{margin:0;height:100%;background:#000}
  #ui{position:fixed;top:8px;left:8px;right:8px;display:flex;gap:8px;z-index:10}
  #sceneLabel{margin-right:auto;padding:6px 10px;background:#0009;color:#fff;border-radius:6px;font:16px/1.2 sans-serif}
  #coord{padding:6px 10px;background:#0009;color:#fff;border-radius:6px;font:12px/1.2 monospace}
  #controls{position:fixed;top:8px;right:8px;z-index:11;display:flex;gap:8px}
  #controls button{padding:8px 10px;border-radius:6px;border:1px solid #0003;background:#fff;cursor:pointer}
</style>
</head>
<body>
<div id="ui">
  <div id="sceneLabel">-</div>
  <div id="coord">pitch:-, yaw:-, fov:-</div>
</div>
<div id="controls">
  <button id="tourPlay">자동투어 시작</button>
  <button id="tourPause">자동투어 정지</button>
</div>

<a-scene renderer="antialias:true" vr-mode-ui="enabled:true">
  <!-- 카메라 + 커서(모바일 탭/헤드기어 응시 클릭) -->
  <a-entity id="rig" position="0 1.6 0">
    <a-entity id="cam" camera="fov:80" look-controls wasd-controls
              cursor="rayOrigin: mouse"
              raycaster="objects: .hs"></a-entity>
  </a-entity>

  <!-- 파노라마 구 -->
  <a-sky id="sky" radius="500" rotation="0 0 0" src=""></a-sky>

  <!-- 핫스팟 컨테이너 -->
  <a-entity id="hotspots"></a-entity>
</a-scene>

<script>
(async function(){
  const cfg = await fetch('tour.config.json', {cache:'no-cache'}).then(r=>r.json());
  const TARGET = cfg.targets || {};
  const sceneNames = cfg.sceneNames || {};
  const FADE_MS = cfg.constants?.FADE_MS ?? 600;
  const AUTO_ROT_SPEED_TOUR = cfg.constants?.AUTO_ROT_SPEED_TOUR ?? 8; // deg/s
  const AUTO_ROT_IDLE_MS = cfg.constants?.AUTO_ROT_IDLE_MS ?? 3000;

  const scenes = {};
  for (const s of cfg.scenes) scenes[s.id] = s;

  const sky = document.getElementById('sky');
  const hsRoot = document.getElementById('hotspots');
  const rig = document.getElementById('rig');
  const cam = document.getElementById('cam');

  function setLabel(id){ document.getElementById('sceneLabel').textContent = sceneNames[id] || id; }
  function setCoord(){
    const rot = rig.getAttribute('rotation');
    const fov = cam.getAttribute('camera').fov;
    document.getElementById('coord').textContent =
      `pitch:${(-rot.x).toFixed(1)}, yaw:${(-rot.y).toFixed(1)}, fov:${fov.toFixed(1)}`;
  }

  // equirect pitch/yaw(도) → 구면 좌표에 배치
  function hotspotPos(pitchDeg, yawDeg, R=499){
    const toRad = Math.PI/180;
    const pitch = pitchDeg*toRad, yaw = yawDeg*toRad;
    const x =  R * Math.cos(pitch)*Math.sin(yaw);
    const y =  R * Math.sin(pitch);
    const z = -R * Math.cos(pitch)*Math.cos(yaw);
    return `${x} ${y} ${z}`;
  }

  function clearHotspots(){ while(hsRoot.firstChild) hsRoot.removeChild(hsRoot.firstChild); }
  function makeHotspot(h){
    const e = document.createElement('a-entity');
    e.setAttribute('class','hs');
    e.setAttribute('geometry','primitive: sphere; radius: 0.6');
    e.setAttribute('material','color: #FFFFFF; metalness:0; roughness:0.2; emissive:#FFFFFF; emissiveIntensity:0.5');
    e.setAttribute('position', hotspotPos(h.pitch, h.yaw));
    e.setAttribute('look-at', '#cam');
    e.setAttribute('title', h.label || '');
    e.addEventListener('click', ()=> go(h.to));
    return e;
  }

  let current="", transitioning=false, touring=false, tourIdx=0, tourTimer=null, idleTimer=null;

  function setFovFromHFOV(hfov){
    // 대략 변환: 수평→수직 FOV. 화면비 16:9 가정.
    const aspect = 16/9;
    const hf = (hfov??100) * Math.PI/180;
    const vf = 2*Math.atan(Math.tan(hf/2)/aspect) * 180/Math.PI;
    cam.setAttribute('camera', 'fov', Math.max(40, Math.min(110, vf)));
  }

  function loadScene(id, p=0, y=0, f=100){
    if (transitioning || !scenes[id]) return;
    transitioning=true;
    const s = scenes[id];
    sky.emit('fadeout');
    setTimeout(()=>{
      sky.setAttribute('src', cfg.assets.panoramas[id]);
      setFovFromHFOV(f || s.hfov);
      rig.setAttribute('rotation', `${-p} ${-y} 0`);
      clearHotspots();
      (s.hotSpots||[]).forEach(h=> hsRoot.appendChild(makeHotspot(h)));
      setLabel(id);
      setCoord();
      sky.emit('fadein');
      current=id; transitioning=false;
    }, FADE_MS/2);
  }

  // 간단 페이드
  AFRAME.registerComponent('fade-sky', {
    init(){
      this.el.setAttribute('animation__out',{
        property:'material.color', to:'#000', startEvents:'fadeout', dur:FADE_MS/2
      });
      this.el.setAttribute('animation__in',{
        property:'material.color', from:'#000', to:'#FFF', startEvents:'fadein', dur:FADE_MS/2
      });
    }
  });
  sky.setAttribute('fade-sky','');

  function go(id){
    const t = TARGET[id] || {p:0,y:0,f: scenes[id]?.hfov ?? 100};
    loadScene(id, t.p, t.y, t.f);
  }
  window.go = go;

  // 자동 투어
  const tourOrder = cfg.tour?.order || Object.keys(scenes);
  const defaultDwell = cfg.tour?.dwellMs ?? 3000;
  const perSceneDwell = cfg.tour?.perSceneDwell || {};
  function tourStep(i){
    const id = tourOrder[i % tourOrder.length];
    const t = TARGET[id] || {p:0,y:0,f: scenes[id]?.hfov ?? 100};
    go(id);
    clearTimeout(tourTimer);
    tourTimer = setTimeout(()=> {
      if(!touring) return;
      tourIdx = (i+1)%tourOrder.length;
      tourStep(tourIdx);
    }, (perSceneDwell[id] ?? defaultDwell) + FADE_MS);
  }
  document.getElementById('tourPlay').onclick = ()=>{ if(touring) return; touring=true; tourStep(tourIdx); };
  document.getElementById('tourPause').onclick = ()=>{ touring=false; clearTimeout(tourTimer); };

  // 유휴 시 자동 회전
  function startAutoRot(){ rig.setAttribute('animation__yaw',`property: rotation; to: 0 -360 0; loop: true; dur:${360/Math.max(1,AUTO_ROT_SPEED_TOUR)*1000}; easing: linear`); }
  function stopAutoRot(){ rig.removeAttribute('animation__yaw'); }
  ['mousedown','touchstart','wheel','keydown'].forEach(ev=>{
    window.addEventListener(ev,()=>{
      stopAutoRot();
      clearTimeout(idleTimer);
      idleTimer=setTimeout(()=>{ if(!touring) startAutoRot(); }, AUTO_ROT_IDLE_MS);
    },{passive:true});
  });

  // 초기화
  const first = cfg.defaults?.firstScene || Object.keys(scenes)[0];
  go(first);
  startAutoRot();

  // 좌표 표시 업데이트
  setInterval(setCoord, 250);
})();
</script>
</body>
</html>
